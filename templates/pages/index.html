{% extends 'components/Layout/base_extendido.html' %}
{% load static %}

{% block content_main %}
<div
    class="container mx-auto px-4 py-6 h-full flex flex-col space-y-6"
    x-data="dashboardApp()"
    x-init="init()"
>
    <!-- ENCABEZADO -->
    <div class="mb-3 flex flex-col md:flex-row justify-between items-start md:items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">
                Dashboard Gerencial
            </h1>
            <p class="text-sm text-gray-500">
                Visualizaci√≥n de √≥rdenes y desempe√±o t√©cnico
            </p>
        </div>

        <div class="flex items-center space-x-3 mt-3 md:mt-0">
            <span class="text-xs text-gray-500" x-show="!loading">
                √öltima actualizaci√≥n: <span x-text="lastUpdate || '‚Äî'"></span>
            </span>
            <button
                type="button"
                @click="init()"
                class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 transition"
                :disabled="loading"
            >
                <span x-show="!loading">Actualizar</span>
                <span x-show="loading">Cargando...</span>
            </button>
        </div>
    </div>

    <!-- FILTROS + QUICK FILTERS -->
    <div class="mb-4 flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div class="flex flex-wrap gap-3">
            <!-- Periodo -->
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Periodo</label>
                <select
                    x-model="periodo"
                    @change="init()"
                    class="border border-gray-300 rounded-lg text-sm px-3 py-2 bg-white"
                >
                    <option value="hoy">Hoy</option>
                    <option value="semana">√öltima semana</option>
                    <option value="mes">√öltimo mes</option>
                    <option value="anio">√öltimo a√±o</option>
                    <option value="personalizado">Personalizado</option>
                </select>
            </div>

            <!-- T√©cnicos (selecci√≥n m√∫ltiple con casillas) -->
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">T√©cnicos</label>

                <!-- Checkbox "Seleccionar todo" -->
                <label
                    class="inline-flex items-center gap-2 mb-2 px-2 py-1 rounded-lg border border-dashed border-gray-300 cursor-pointer text-xs hover:bg-gray-50"
                >
                    <input
                        type="checkbox"
                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        :checked="tecnicos.length && tecnicosSeleccionados.length === tecnicos.length"
                        @change="toggleSeleccionarTodos($event)"
                    >
                    <span class="font-semibold text-gray-700">(Seleccionar todo)</span>
                </label>

                <!-- Lista de t√©cnicos en "cuadrados" -->
                <div
                    class="bg-white rounded-lg border border-gray-200 p-2 max-h-28 overflow-y-auto
                           grid grid-cols-1 sm:grid-cols-2 gap-2"
                >
                    <template x-for="tec in tecnicos" :key="tec.id">
                        <label
                            class="flex items-center gap-2 px-2 py-1 rounded-md border border-gray-200
                                   cursor-pointer hover:bg-gray-50"
                        >
                            <input
                                type="checkbox"
                                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                :value="String(tec.id)"
                                x-model="tecnicosSeleccionados"
                                @change="init()"
                            >
                            <span class="text-xs text-gray-700" x-text="tec.nombre"></span>
                        </label>
                    </template>

                    <!-- Mensaje cuando no hay t√©cnicos -->
                    <p
                        class="col-span-full text-[11px] text-gray-400"
                        x-show="!tecnicos.length && !loading"
                    >
                        No hay t√©cnicos para filtrar.
                    </p>
                </div>

                <p class="mt-1 text-[11px] text-gray-400">
                    Marca uno o varios t√©cnicos, o deja todos sin marcar para ver el total.
                </p>
            </div>

            <!-- Rango personalizado -->
            <div
                class="flex items-end gap-2"
                x-show="periodo === 'personalizado'"
                x-cloak
            >
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Desde</label>
                    <input
                        type="date"
                        x-model="fechaInicio"
                        class="border border-gray-300 rounded-lg text-sm px-3 py-2 bg-white"
                    >
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Hasta</label>
                    <input
                        type="date"
                        x-model="fechaFin"
                        class="border border-gray-300 rounded-lg text-sm px-3 py-2 bg-white"
                    >
                </div>
                <button
                    type="button"
                    @click="init()"
                    class="px-3 py-2 rounded-lg text-xs font-semibold text-white bg-slate-700 hover:bg-slate-800"
                >
                    Aplicar
                </button>
            </div>
        </div>

        <!-- Filtros r√°pidos -->
        <div class="flex flex-wrap gap-2 mt-2 md:mt-0">
            <button
                type="button"
                @click="aplicarFiltroRapido('hoy_estrella')"
                class="px-4 py-2 rounded-full text-xs font-medium border"
                :class="filtroRapidoActivo === 'hoy_estrella'
                    ? 'bg-blue-600 text-white border-blue-600'
                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'"
            >
                Hoy ‚Äì t√©cnico estrella
            </button>

            <button
                type="button"
                @click="aplicarFiltroRapido('pendientes_semana')"
                class="px-4 py-2 rounded-full text-xs font-medium border"
                :class="filtroRapidoActivo === 'pendientes_semana'
                    ? 'bg-amber-500 text-white border-amber-500'
                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'"
            >
                √öltima semana ‚Äì solo pendientes
            </button>

            <!-- Restablecer filtros -->
            <button
                type="button"
                @click="resetFiltros()"
                class="px-4 py-2 rounded-full text-xs font-medium border bg-white text-gray-700 border-gray-300 hover:bg-gray-50"
            >
                Restablecer filtros
            </button>

            <!-- Informe PDF -->
            <button
                type="button"
                @click="exportarPDF()"
                class="px-4 py-2 rounded-full text-xs font-medium border bg-blue-600 text-white hover:bg-blue-700"
            >
                Informe PDF
            </button>
        </div>
    </div>

    <!-- ALERTAS OPERACIONALES -->
    <template x-if="alertas.length">
        <div class="mb-4 rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800">
            <div class="flex items-center justify-between mb-1">
                <div class="font-semibold flex items-center gap-2">
                    <span>‚ö†Ô∏è Alertas operacionales</span>
                </div>
                <span class="text-[11px] text-amber-700" x-text="periodoLabel()"></span>
            </div>
            <ul class="list-disc pl-5 space-y-1">
                <template x-for="(msg, idx) in alertas" :key="idx">
                    <li x-text="msg"></li>
                </template>
            </ul>
        </div>
    </template>

    <!-- MENSAJE DE ERROR -->
    <template x-if="error">
        <div class="p-3 rounded-md bg-red-100 text-red-700 text-sm">
            Error al cargar datos: <span x-text="error"></span>
        </div>
    </template>

    <!-- KPIs 2x2 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Total √≥rdenes -->
        <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-xs font-medium text-gray-500">TOTAL DE √ìRDENES</h3>
            <p class="mt-2 text-3xl font-bold text-gray-900" x-text="total_ordenes"></p>
            <p class="text-xs text-gray-400 mt-1">En el per√≠odo seleccionado.</p>
        </div>

        <!-- % Pendientes -->
        <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-xs font-medium text-gray-500">% PENDIENTES</h3>
            <p class="mt-2 text-3xl font-bold text-amber-500" x-text="porc_pendientes.toFixed(0) + '%'"></p>
            <p class="text-xs text-gray-400 mt-1">Sobre el total de √≥rdenes.</p>
        </div>

        <!-- % En ejecuci√≥n -->
        <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-xs font-medium text-gray-500">% EN EJECUCI√ìN</h3>
            <p class="mt-2 text-3xl font-bold text-blue-500" x-text="porc_en_ejecucion.toFixed(0) + '%'"></p>
            <p class="text-xs text-gray-400 mt-1">T√©cnicos trabajando actualmente.</p>
        </div>

        <!-- % Terminadas -->
        <div class="bg-white rounded-xl shadow p-4">
            <h3 class="text-xs font-medium text-gray-500">% TERMINADAS</h3>
            <p class="mt-2 text-3xl font-bold text-emerald-500" x-text="porc_terminadas.toFixed(0) + '%'"></p>
            <p class="text-xs text-gray-400 mt-1">√ìrdenes completadas en el per√≠odo.</p>
        </div>
    </div>

    <!-- TARJETAS 1x3 (click abre modal) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Pendientes -->
        <button
            type="button"
            class="bg-white rounded-xl shadow p-4 flex items-center justify-between text-left hover:bg-slate-50 transition"
            @click="abrirModal('pendientes')"
        >
            <div>
                <h3 class="text-xs font-medium text-gray-500">PENDIENTES</h3>
                <p class="mt-2 text-3xl font-bold text-rose-500" x-text="kpis_pendientes"></p>
                <p class="text-xs text-gray-400 mt-1">Por asignar o iniciar</p>
            </div>
            <div class="text-amber-500 text-3xl">
                ‚ö†Ô∏è
            </div>
        </button>

        <!-- En ejecuci√≥n -->
        <button
            type="button"
            class="bg-white rounded-xl shadow p-4 flex items-center justify-between text-left hover:bg-slate-50 transition"
            @click="abrirModal('en_ejecucion')"
        >
            <div>
                <h3 class="text-xs font-medium text-gray-500">EN EJECUCI√ìN</h3>
                <p class="mt-2 text-3xl font-bold text-orange-500" x-text="kpis_en_proceso"></p>
                <p class="text-xs text-gray-400 mt-1">T√©cnicos trabajando</p>
            </div>
            <div class="text-orange-500 text-3xl">
                ‚ö°
            </div>
        </button>

        <!-- Terminadas -->
        <button
            type="button"
            class="bg-white rounded-xl shadow p-4 flex items-center justify-between text-left hover:bg-slate-50 transition"
            @click="abrirModal('terminadas')"
        >
            <div>
                <h3 class="text-xs font-medium text-gray-500">TERMINADAS</h3>
                <p class="mt-2 text-3xl font-bold text-emerald-500" x-text="kpis_terminadas"></p>
                <p class="text-xs text-gray-400 mt-1">En este per√≠odo</p>
            </div>
            <div class="text-emerald-500 text-3xl">
                ‚úÖ
            </div>
        </button>
    </div>

    <!-- SLA / TIEMPO PROMEDIO -->
    <div class="bg-white rounded-xl shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h3 class="text-sm font-medium text-gray-500">CUMPLIMIENTO SLA</h3>
            <p class="mt-2 text-3xl font-bold text-indigo-600" x-text="sla_porcentaje + '%'"></p>
            <p class="text-xs text-gray-400 mt-1">
                √ìrdenes dentro del SLA configurado.
            </p>
        </div>
        <div class="mt-3 md:mt-0 text-[11px] text-gray-500 leading-snug">
            <div>
                Fuera de SLA:
                <span class="font-semibold text-red-500" x-text="sla_fuera"></span>
            </div>
            <div>
                Tiempo prom. cierre:
                <span class="font-semibold" x-text="tiempo_promedio_cierre.toFixed(1) + ' h'"></span>
            </div>
        </div>
    </div>

    <!-- TOP 3 T√âCNICOS -->
    <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-semibold text-gray-700">
                Top 3 t√©cnicos del per√≠odo
            </h2>
            <span class="text-xs text-gray-400" x-text="periodoLabel()"></span>
        </div>

        <div class="flex flex-col md:flex-row gap-3">
            <template x-for="(tec, idx) in ranking_tecnicos.slice(0,3)" :key="tec.id || tec.nombre">
                <div class="flex-1 border rounded-lg px-3 py-2 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-xl" x-text="idx === 0 ? 'ü•á' : (idx === 1 ? 'ü•à' : 'ü•â')"></span>
                        <div>
                            <p class="text-xs font-semibold text-gray-700" x-text="tec.nombre"></p>
                            <p class="text-[11px] text-gray-400">
                                <span x-text="tec.terminadas"></span> √≥rdenes ¬∑
                                SLA <span x-text="tec.sla_porcentaje + '%'"></span>
                            </p>
                        </div>
                    </div>
                    <span
                        class="text-[11px] px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 font-semibold"
                        x-text="(tec.tiempo_promedio_cierre_horas || 0).toFixed(1) + ' h prom.'"
                    ></span>
                </div>
            </template>

            <template x-if="ranking_tecnicos.length === 0">
                <p class="text-xs text-gray-400">No hay datos suficientes en este per√≠odo.</p>
            </template>
        </div>
    </div>

    <!-- GR√ÅFICOS PRINCIPALES -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Gr√°fico de tendencia -->
        <div class="bg-white rounded-xl shadow p-4">
            <h2 class="text-sm font-semibold text-gray-700">
                Demanda y Tendencia de √ìrdenes
            </h2>
            <p class="text-xs text-gray-400">
                √ìrdenes creadas por d√≠a en el per√≠odo seleccionado.
            </p>
            <div class="mt-4">
                <canvas id="chartTendencia" class="w-full h-48"></canvas>
            </div>
        </div>

        <!-- √ìrdenes por t√©cnico -->
        <div class="bg-white rounded-xl shadow p-4">
            <h2 class="text-sm font-semibold text-gray-700">
                √ìrdenes por T√©cnico
            </h2>
            <p class="text-xs text-gray-400">
                Cantidad de √≥rdenes asignadas por t√©cnico en el per√≠odo.
            </p>
            <div class="mt-4">
                <canvas id="chartTecnicos" class="w-full h-48"></canvas>
            </div>

            <div class="mt-4 border-t pt-3">
                <p class="text-xs text-gray-500">
                    Productividad general:
                    <span class="font-semibold text-indigo-600" x-text="productividad_tecnica + '%'"></span>
                    &nbsp;de √≥rdenes terminadas respecto del total del per√≠odo.
                </p>
            </div>
        </div>
    </div>

    <!-- PIE DE ESTADOS -->
    <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-sm font-semibold text-gray-700">
            Distribuci√≥n de Estados
        </h2>
        <p class="text-xs text-gray-400">
            Proporci√≥n de √≥rdenes pendientes, en ejecuci√≥n y terminadas en el per√≠odo.
        </p>
        <div class="mt-4">
            <canvas id="chartEstados" class="w-full h-64"></canvas>
        </div>
    </div>

    <!-- RANKING T√âCNICOS TABLA COMPLETA -->
    <div class="bg-white rounded-xl shadow">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-700">
                Ranking de T√©cnicos (solo √≥rdenes terminadas)
            </h2>
            <span class="text-xs text-gray-400">
                Ordenado por cantidad de √≥rdenes terminadas en el per√≠odo.
            </span>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-xs md:text-sm">
                <thead class="bg-gray-50 text-gray-500">
                    <tr>
                        <th class="px-4 py-2 text-left font-medium">T√âCNICO</th>
                        <th class="px-4 py-2 text-left font-medium">TERMINADAS</th>
                        <th class="px-4 py-2 text-left font-medium">% SLA OK</th>
                        <th class="px-4 py-2 text-left font-medium">T. PROM. (h)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr x-show="!loading && ranking_tecnicos.length === 0">
                        <td colspan="4" class="px-4 py-4 text-center text-gray-400">
                            No hay datos de t√©cnicos en este per√≠odo.
                        </td>
                    </tr>

                    <template x-for="tec in ranking_tecnicos" :key="tec.id || tec.nombre">
                        <tr class="border-t border-gray-100">
                            <td class="px-4 py-2 text-gray-700" x-text="tec.nombre"></td>
                            <td class="px-4 py-2 text-gray-700" x-text="tec.terminadas"></td>
                            <td class="px-4 py-2 text-gray-700" x-text="tec.sla_porcentaje + '%'"></td>
                            <td class="px-4 py-2 text-gray-700" x-text="(tec.tiempo_promedio_cierre_horas || 0).toFixed(1)"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- HISTORIAL √ìRDENES CERRADAS -->
    <div class="bg-white rounded-xl shadow">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-700">
                √öltimas √ìrdenes Cerradas
            </h2>

            <div class="flex items-center gap-3">
                <span class="text-xs text-gray-400" x-text="'En este per√≠odo (' + historial.length + ' registros)'"></span>

                <!-- Bot√≥n Exportar CSV -->
                <button
                    type="button"
                    class="px-3 py-1.5 text-xs rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50"
                    @click="exportarHistorial()"
                >
                    Exportar CSV
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-xs md:text-sm">
                <thead class="bg-gray-50 text-gray-500">
                    <tr>
                        <th class="px-4 py-2 text-left font-medium">ID</th>
                        <th class="px-4 py-2 text-left font-medium">T√âCNICO</th>
                        <th class="px-4 py-2 text-left font-medium">CLIENTE</th>
                        <th class="px-4 py-2 text-left font-medium">FECHA CIERRE</th>
                    </tr>
                </thead>
                <tbody>
                    <tr x-show="!loading && historial.length === 0">
                        <td colspan="4" class="px-4 py-4 text-center text-gray-400">
                            No hay √≥rdenes cerradas en este per√≠odo.
                        </td>
                    </tr>

                    <template x-for="orden in historial" :key="orden.id">
                        <tr class="border-t border-gray-100">
                            <td class="px-4 py-2 text-gray-700" x-text="orden.id"></td>
                            <td class="px-4 py-2 text-gray-700" x-text="orden.tecnico"></td>
                            <td class="px-4 py-2 text-gray-700" x-text="orden.cliente"></td>
                            <td class="px-4 py-2 text-gray-700" x-text="orden.fecha_cierre"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- MODAL DETALLE √ìRDENES -->
    <div
        x-show="modalAbierto"
        x-cloak
        class="fixed inset-0 z-40 flex items-center justify-center bg-black/40"
    >
        <div class="bg-white rounded-xl shadow-xl w-full max-w-5xl max-h-[80vh] flex flex-col">
            <div class="px-4 py-3 border-b flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-800" x-text="modalTitulo"></h3>
                <button
                    type="button"
                    class="text-gray-400 hover:text-gray-600"
                    @click="cerrarModal()"
                >
                    ‚úï
                </button>
            </div>

            <div class="flex-1 overflow-auto">
                <table class="min-w-full text-xs md:text-sm">
                    <thead class="bg-gray-50 text-gray-500">
                        <tr>
                            <th class="px-4 py-2 text-left font-medium">ID</th>
                            <th class="px-4 py-2 text-left font-medium">CLIENTE</th>
                            <th class="px-4 py-2 text-left font-medium">T√âCNICO</th>
                            <th class="px-4 py-2 text-left font-medium">ESTADO</th>
                            <th class="px-4 py-2 text-left font-medium">FECHA</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr x-show="loadingModal">
                            <td colspan="5" class="px-4 py-6 text-center text-gray-400">
                                Cargando √≥rdenes...
                            </td>
                        </tr>

                        <tr x-show="!loadingModal && ordenesModal.length === 0">
                            <td colspan="5" class="px-4 py-6 text-center text-gray-400">
                                No hay √≥rdenes para este filtro.
                            </td>
                        </tr>

                        <template x-for="ot in ordenesModal" :key="ot.id">
                            <tr class="border-t border-gray-100">
                                <td class="px-4 py-2 text-gray-700" x-text="ot.id"></td>
                                <td class="px-4 py-2 text-gray-700" x-text="ot.cliente_nombre || ot.cliente || ''"></td>
                                <td class="px-4 py-2 text-gray-700" x-text="ot.tecnico_nombre || ot.tecnico || ''"></td>
                                <td class="px-4 py-2 text-gray-700" x-text="ot.estado_display || ot.estado"></td>
                                <td class="px-4 py-2 text-gray-700" x-text="ot.fecha_creacion || ot.fecha_cierre || ''"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <div class="px-4 py-3 border-t flex justify-end">
                <button
                    type="button"
                    class="px-4 py-2 text-sm rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50"
                    @click="cerrarModal()"
                >
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPT DEL DASHBOARD (AlpineJS + Chart.js) -->
<script>
    function dashboardApp() {
        return {
            // estado general
            loading: true,
            error: null,
            lastUpdate: null,

            // filtros
            periodo: 'mes',
            tecnicosSeleccionados: [],
            fechaInicio: '',
            fechaFin: '',
            tecnicos: [],
            filtroRapidoActivo: null,

            // KPIs planos
            total_ordenes: 0,
            porc_pendientes: 0,
            porc_en_ejecucion: 0,
            porc_terminadas: 0,

            // KPIs legacy
            kpis_pendientes: 0,
            kpis_en_proceso: 0,
            kpis_terminadas: 0,
            productividad_tecnica: 0,

            // SLA
            tiempo_promedio_cierre: 0,
            sla_porcentaje: 0,
            sla_fuera: 0,

            // tablas / datos
            historial: [],
            grafico_tendencia: { fechas: [], real: [], prediccion: [] },
            grafico_tecnicos: { categorias: [], valores: [] },
            grafico_estados: { labels: [], valores: [] },
            ranking_tecnicos: [],

            // alertas
            alertas: [],
            alertas_detalle: { pendientes_vencidas: 0, tecnicos_sobrecarga: [], umbral_sobrecarga: 0 },

            // instancias Chart.js
            chartTendencia: null,
            chartTecnicos: null,
            chartEstados: null,

            // modal
            modalAbierto: false,
            modalTitulo: '',
            modalTipo: '',
            ordenesModal: [],
            loadingModal: false,

            async init() {
                this.loading = true;
                this.error = null;

                try {
                    const params = new URLSearchParams();

                    if (this.periodo) params.append('periodo', this.periodo);

                    // varios t√©cnicos
                    if (this.tecnicosSeleccionados.length) {
                        params.append('tecnicos', this.tecnicosSeleccionados.join(','));
                    }

                    if (this.periodo === 'personalizado' && this.fechaInicio && this.fechaFin) {
                        params.append('inicio', this.fechaInicio);
                        params.append('fin', this.fechaFin);
                    }

                    const url = '/api/v1/dashboard-stats/' + (params.toString() ? '?' + params.toString() : '');

                    const response = await fetch(url, {
                        headers: { 'Accept': 'application/json' },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        throw new Error('Error HTTP ' + response.status);
                    }

                    const data = await response.json();

                    // KPIs principales
                    this.kpis_pendientes   = data.kpis_pendientes   ?? data.kpis?.pendientes   ?? 0;
                    this.kpis_en_proceso   = data.kpis_en_proceso   ?? data.kpis?.en_proceso   ?? 0;
                    this.kpis_terminadas   = data.kpis_terminadas   ?? data.kpis?.terminadas   ?? 0;
                    this.productividad_tecnica = data.productividad_tecnica ?? data.kpis?.productividad_tecnica ?? 0;

                    const total = (this.kpis_pendientes + this.kpis_en_proceso + this.kpis_terminadas) || 0;
                    this.total_ordenes = total;
                    this.porc_pendientes   = total ? (this.kpis_pendientes   * 100) / total : 0;
                    this.porc_en_ejecucion = total ? (this.kpis_en_proceso   * 100) / total : 0;
                    this.porc_terminadas   = total ? (this.kpis_terminadas   * 100) / total : 0;

                    // SLA
                    this.tiempo_promedio_cierre = data.kpi_tiempo_promedio_cierre_horas ?? data.kpis?.tiempo_promedio_cierre_horas ?? 0;
                    this.sla_porcentaje         = data.kpi_sla_porcentaje                ?? data.kpis?.sla_porcentaje                ?? 0;
                    this.sla_fuera              = data.kpi_sla_fuera                     ?? data.kpis?.sla_fuera                     ?? 0;

                    // tabla historial
                    this.historial = Array.isArray(data.historial) ? data.historial : [];

                    // gr√°ficos
                    this.grafico_tendencia = data.grafico_tendencia || { fechas: [], real: [], prediccion: [] };
                    this.grafico_tecnicos  = data.grafico_tecnicos  || { categorias: [], valores: [] };
                    this.grafico_estados   = data.grafico_estados   || { labels: [], valores: [] };

                    // ranking
                    this.ranking_tecnicos = Array.isArray(data.ranking_tecnicos) ? data.ranking_tecnicos : [];

                    // alertas
                    this.alertas = Array.isArray(data.alertas) ? data.alertas : [];
                    this.alertas_detalle = data.alertas_detalle || { pendientes_vencidas: 0, tecnicos_sobrecarga: [], umbral_sobrecarga: 0 };

                    // t√©cnicos disponibles
                    this.tecnicos = Array.isArray(data.filtros_disponibles) ? data.filtros_disponibles : [];

                    this.lastUpdate = new Date().toLocaleString();

                    this.$nextTick(() => {
                        this.renderCharts();
                    });

                } catch (err) {
                    console.error(err);
                    this.error = err.message || 'Error desconocido';
                } finally {
                    this.loading = false;
                }
            },

            aplicarFiltroRapido(nombre) {
                this.filtroRapidoActivo = nombre;

                if (nombre === 'hoy_estrella') {
                    this.periodo = 'hoy';

                    if (this.ranking_tecnicos.length) {
                        const topId = this.ranking_tecnicos[0].id || '';
                        this.tecnicosSeleccionados = topId ? [String(topId)] : [];
                    } else {
                        this.tecnicosSeleccionados = [];
                    }

                    this.init();
                } else if (nombre === 'pendientes_semana') {
                    this.periodo = 'semana';
                    this.tecnicosSeleccionados = [];
                    this.init();
                }
            },

            resetFiltros() {
                this.periodo = 'mes';
                this.tecnicosSeleccionados = [];
                this.fechaInicio = '';
                this.fechaFin = '';
                this.filtroRapidoActivo = null;
                this.init();
            },

            // nuevo: seleccionar / deseleccionar todos los t√©cnicos
            toggleSeleccionarTodos(event) {
                const checked = event.target.checked;

                if (checked) {
                    this.tecnicosSeleccionados = this.tecnicos.map(t => String(t.id));
                } else {
                    this.tecnicosSeleccionados = [];
                }

                this.init();
            },

            async abrirModal(tipo) {
                this.modalTipo = tipo;
                this.modalAbierto = true;
                this.loadingModal = true;
                this.ordenesModal = [];

                let estadoParam = '';
                if (tipo === 'pendientes') {
                    this.modalTitulo = '√ìrdenes pendientes';
                    estadoParam = 'PENDIENTE';
                } else if (tipo === 'en_ejecucion') {
                    this.modalTitulo = '√ìrdenes en ejecuci√≥n';
                    estadoParam = 'EN_PROCESO';
                } else if (tipo === 'terminadas') {
                    this.modalTitulo = '√ìrdenes terminadas';
                    estadoParam = 'TERMINADO';
                }

                try {
                    const params = new URLSearchParams();
                    if (estadoParam) {
                        params.append('estado', estadoParam);
                    }

                    const url = '/api/v1/ordenes/' + (params.toString() ? '?' + params.toString() : '');
                    const resp = await fetch(url, {
                        headers: { 'Accept': 'application/json' },
                        credentials: 'same-origin'
                    });

                    if (!resp.ok) {
                        throw new Error('Error HTTP ' + resp.status);
                    }

                    const data = await resp.json();
                    this.ordenesModal = Array.isArray(data) ? data : (data.results || []);

                } catch (e) {
                    console.error(e);
                    this.ordenesModal = [];
                } finally {
                    this.loadingModal = false;
                }
            },

            cerrarModal() {
                this.modalAbierto = false;
                this.modalTipo = '';
                this.modalTitulo = '';
                this.ordenesModal = [];
            },

            renderCharts() {
                // === Gr√°fico de tendencia ===
                const canvas1 = document.getElementById('chartTendencia');
                if (canvas1) {
                    if (this.chartTendencia) {
                        this.chartTendencia.destroy();
                        this.chartTendencia = null;
                    }

                    if (this.grafico_tendencia.fechas.length) {
                        this.chartTendencia = new Chart(canvas1, {
                            type: 'line',
                            data: {
                                labels: this.grafico_tendencia.fechas,
                                datasets: [
                                    {
                                        label: '√ìrdenes creadas',
                                        data: this.grafico_tendencia.real,
                                        fill: false,
                                        tension: 0.3,
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: true },
                                },
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                    }
                }

                // === Gr√°fico √≥rdenes por t√©cnico ===
                const canvas2 = document.getElementById('chartTecnicos');
                if (canvas2) {
                    if (this.chartTecnicos) {
                        this.chartTecnicos.destroy();
                        this.chartTecnicos = null;
                    }

                    if (this.grafico_tecnicos.categorias.length) {
                        this.chartTecnicos = new Chart(canvas2, {
                            type: 'bar',
                            data: {
                                labels: this.grafico_tecnicos.categorias,
                                datasets: [
                                    {
                                        label: '√ìrdenes',
                                        data: this.grafico_tecnicos.valores,
                                    }
                                ]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                plugins: {
                                    legend: { display: false },
                                },
                                scales: {
                                    x: { beginAtZero: true }
                                }
                            }
                        });
                    }
                }

                // === Gr√°fico de estados (pie) ===
                const canvas3 = document.getElementById('chartEstados');
                if (canvas3) {
                    if (this.chartEstados) {
                        this.chartEstados.destroy();
                        this.chartEstados = null;
                    }

                    if (this.grafico_estados.labels.length) {
                        this.chartEstados = new Chart(canvas3, {
                            type: 'pie',
                            data: {
                                labels: this.grafico_estados.labels,
                                datasets: [
                                    {
                                        data: this.grafico_estados.valores,
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'top' },
                                }
                            }
                        });
                    }
                }
            },

            exportarHistorial() {
                const params = new URLSearchParams();

                if (this.periodo) {
                    params.append('periodo', this.periodo);
                }
                if (this.tecnicosSeleccionados.length) {
                    params.append('tecnicos', this.tecnicosSeleccionados.join(','));
                }
                if (this.periodo === 'personalizado' && this.fechaInicio && this.fechaFin) {
                    params.append('inicio', this.fechaInicio);
                    params.append('fin', this.fechaFin);
                }

                const url = '/api/v1/dashboard-historial.csv' + (params.toString() ? '?' + params.toString() : '');
                window.location.href = url;
            },

            // descarga del informe PDF completo
            exportarPDF() {
                const params = new URLSearchParams();

                if (this.periodo) {
                    params.append('periodo', this.periodo);
                }
                if (this.tecnicosSeleccionados.length) {
                    params.append('tecnicos', this.tecnicosSeleccionados.join(','));
                }
                if (this.periodo === 'personalizado' && this.fechaInicio && this.fechaFin) {
                    params.append('inicio', this.fechaInicio);
                    params.append('fin', this.fechaFin);
                }

                const url = '/api/v1/dashboard-informe.pdf' + (params.toString() ? '?' + params.toString() : '');
                window.location.href = url;
            },

            periodoLabel() {
                switch (this.periodo) {
                    case 'hoy': return 'Hoy';
                    case 'semana': return '√öltima semana';
                    case 'mes': return '√öltimo mes';
                    case 'anio': return '√öltimo a√±o';
                    case 'personalizado': return 'Rango personalizado';
                    default: return this.periodo;
                }
            }
        }
    }
</script>

{% endblock %}
