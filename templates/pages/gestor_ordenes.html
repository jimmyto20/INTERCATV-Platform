{% extends 'components/Layout/base_extendido.html' %}
{% load static %}


{% block content_main %}
<div class="container mx-auto px-4 py-6 h-full flex flex-col space-y-6">

    <div class="mb-4 flex flex-col md:flex-row justify-between items-start">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">
                Centro de Control Operativo
            </h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">Monitoreo de Flota y Asignaciones (Google Maps)</p>
        </div>
        
        <button id="emergency-button" onclick="toggleEmergencyMode()"
            class="mt-2 md:mt-0 px-4 py-2 rounded-lg font-semibold text-white bg-gray-500 hover:bg-gray-600 transition-colors duration-200">
            Cargar Estado...
        </button>
    </div>

    <div id="emergency-banner" class="hidden p-4 text-center text-white bg-red-600 rounded-lg shadow-lg">
        <strong class="font-bold">üö® ¬°MODO DE EMERGENCIA ACTIVADO! üö®</strong>
        <p id="emergency-banner-message">El chatbot est√° informando a los clientes de una falla masiva.</p>
    </div>

    <div class="rounded-xl overflow-hidden shadow-lg border border-gray-200 dark:border-gray-700 relative z-0">
        <div id="map" style="width: 100%; height: 400px; background-color: #e5e7eb;"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="flex flex-col bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
            <div class="p-3 border-b border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 rounded-t-xl flex justify-between items-center">
                <h2 class="font-bold text-gray-700 dark:text-gray-200">üî¥ Pendientes</h2>
                <span id="badge-pendientes" class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
            <div id="col-pendientes" class="p-4 space-y-3 overflow-y-auto max-h-[500px]">
                <p class="text-center text-gray-400 text-sm py-4">Cargando...</p>
            </div>
        </div>
        <div class="flex flex-col bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
            <div class="p-3 border-b border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 rounded-t-xl flex justify-between items-center">
                <h2 class="font-bold text-gray-700 dark:text-gray-200">üü° Asignadas</h2>
                <span id="badge-asignadas" class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
            <div id="col-asignadas" class="p-4 space-y-3 overflow-y-auto max-h-[500px]">
                <p class="text-center text-gray-400 text-sm py-4">Cargando...</p>
            </div>
        </div>
        <div class="flex flex-col bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
            <div class="p-3 border-b border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 rounded-t-xl flex justify-between items-center">
                <h2 class="font-bold text-gray-700 dark:text-gray-200">üü¢ En Ejecuci√≥n</h2>
                <span id="badge-ejecucion" class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
            <div id="col-ejecucion" class="p-4 space-y-3 overflow-y-auto max-h-[500px]">
                <p class="text-center text-gray-400 text-sm py-4">Cargando...</p>
            </div>
        </div>
    </div>
    
    <div class="flex flex-col bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-lg">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h2 class="font-bold text-gray-900 dark:text-white">üë• Estado de Flota</h2>
            <span id="badge-tecnicos" class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-bold px-2 py-1 rounded-full">0</span>
        </div>
        <div id="col-tecnicos" class="p-2 overflow-y-auto max-h-[400px] divide-y divide-gray-200 dark:divide-gray-700">
            <p class="text-center text-gray-400 text-sm py-4">Cargando flota...</p>
        </div>
    </div>

    <div id="protocol-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Protocolo de Emergencia (ITIL)</h3>
                <button onclick="closeProtocolModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">&times;</button>
            </div>
            <div class="p-6 text-gray-700 dark:text-gray-300">
                <h4 class="font-bold text-lg mb-2">Protocolo: CORTE MASIVO DE FIBRA</h4>
                <ol class="list-decimal list-inside space-y-2">
                    <li>Activar el Modo Emergencia en el Dashboard (¬°Hecho!).</li>
                    <li>Informar al supervisor de √°rea (Marcelo Polanco) sobre la zona afectada.</li>
                    <li>Detener asignaciones de instalaciones nuevas (priorizar corte).</li>
                    <li>Asignar TODOS los t√©cnicos disponibles de la zona afectada a la emergencia.</li>
                    <li>Monitorear la columna "En Ejecuci√≥n" y el mapa.</li>
                    <li>Desactivar el Modo Emergencia solo cuando el supervisor confirme la restauraci√≥n del servicio.</li>
                </ol>
            </div>
            <div class="flex items-center justify-end p-4 bg-gray-50 dark:bg-gray-900 border-t dark:border-gray-700 rounded-b-lg">
                <button type="button" onclick="closeProtocolModal()" class="px-4 py-2 bg-blue-600 rounded-md text-sm font-medium text-white hover:bg-blue-700">
                    Entendido
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock content_main %}


{% block javascript %}
<script>
    // --- Variables Globales ---
    let map;
    let markers = {}; 
    let allTechnicians = [];
    let SystemState = { is_emergency: false }; 
    
    // --- Elementos del DOM (se asignan en DOMContentLoaded) ---
    let emergencyButton, emergencyBanner, emergencyBannerMessage, protocolModal;

    // --- CSRF TOKEN ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- GOOGLE MAPS ---
    window.initMap = function() {
        const chillan = { lat: -36.6066, lng: -72.1036 };
        try {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 10, center: chillan, mapTypeControl: false, streetViewControl: false
            });
            
            // --- ¬°CORRECCI√ìN! ---
            // Llamamos a la carga de datos tan pronto como el mapa est√° listo.
            loadKanbanBoard(); 
            
        } catch (e) {
            console.error("Error al iniciar Google Maps. Revisa tu API Key.", e);
            document.getElementById("map").innerText = "Error al cargar Google Maps. Revisa la consola (F12) y tu API Key.";
        }
    }

    // --- FUNCI√ìN DE MAPA (LA QUE FALTABA) ---
    function updateMapMarkers(technicians) {
        // Limpiar marcadores de t√©cnicos que ya NO est√°n disponibles
        Object.keys(markers).forEach(tecId => {
            const isStillAvailable = technicians.some(tec => tec.id == tecId);
            if (!isStillAvailable && markers[tecId]) {
                markers[tecId].setMap(null); // Quitar del mapa
                delete markers[tecId];
            }
        });

        // A√±adir o mover marcadores de t√©cnicos disponibles
        technicians.forEach(tec => {
            if (tec.ubicacion_actual) {
                try {
                    const [latStr, lngStr] = tec.ubicacion_actual.split(',');
                    const position = { lat: parseFloat(latStr), lng: parseFloat(lngStr) };
                    
                    if (markers[tec.id]) {
                        markers[tec.id].setPosition(position);
                    } else {
                        const marker = new google.maps.Marker({
                            position: position, map: map, title: tec.nombre,
                            animation: google.maps.Animation.DROP
                        });
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div style="color:black; padding:4px;"><strong>${tec.nombre}</strong><br><span style="font-size:12px; color:#555;">${tec.especialidad}</span></div>`
                        });
                        marker.addListener("click", () => infoWindow.open(map, marker));
                        markers[tec.id] = marker;
                    }
                } catch(e) { console.warn("Coordenada inv√°lida:", tec.nombre); }
            }
        });
    }

    // --- KANBAN & TARJETAS ---
    function createOrderCard(orden, type) {
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-900 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow mb-3';
        card.id = `orden-${orden.id}`;
        // card.setAttribute('onclick', `openModal(${orden.id})`); // Descomentar si tienes el modal

        let priorityColor = 'bg-gray-100 text-gray-800';
        if(orden.prioridad === 'ALTA') priorityColor = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        if(orden.prioridad === 'MEDIA') priorityColor = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
        if(orden.prioridad === 'BAJA') priorityColor = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';

        let contentHtml = `
            <div class="flex justify-between items-start mb-2">
                <span class="text-xs font-bold text-gray-500 dark:text-gray-400">#${orden.id}</span>
                <span class="text-xs font-bold px-2 py-0.5 rounded ${priorityColor}">${orden.prioridad}</span>
            </div>
            <h3 class="font-semibold text-gray-800 dark:text-gray-200 text-sm mb-1 truncate">${orden.cliente_detalle?.nombre || 'Cliente desconocido'}</h3>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-3 line-clamp-2">${orden.descripcion}</p>
        `;

        if (type === 'PENDIENTE') {
            let options = `<option value="">Asignar a...</option>`;
            allTechnicians.forEach(tec => {
                options += `<option value="${tec.id}">${tec.nombre}</option>`;
            });
            contentHtml += `
                <div class="mt-2" onclick="event.stopPropagation();">
                    <select onchange="assignTechnician(this, ${orden.id})" 
                        class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                        ${options}
                    </select>
                </div>
            `;
        } else {
            contentHtml += `
                <div class="mt-2 pt-2 border-t border-gray-100 dark:border-gray-700 flex items-center gap-2">
                    <div class="h-6 w-6 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-xs font-bold text-blue-600 dark:text-blue-300">
                        ${orden.tecnico_detalle?.nombre.charAt(0) || 'T'}
                    </div>
                    <span class="text-xs text-gray-600 dark:text-gray-300 truncate">${orden.tecnico_detalle?.nombre || 'Sin t√©cnico'}</span>
                </div>
            `;
        }
        card.innerHTML = contentHtml;
        return card;
    }

    async function assignTechnician(select, ordenId) {
        const tecnicoId = select.value;
        if (!tecnicoId) return;
        const card = document.getElementById(`orden-${ordenId}`);
        card.style.opacity = '0.5';
        try {
            const response = await fetch(`/api/v1/ordenes/${ordenId}/`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ tecnico: tecnicoId, estado: 'ASIGNADA' })
            });
            if (response.ok) { loadKanbanBoard(); } else { alert("Error al asignar"); card.style.opacity = '1'; }
        } catch (error) { console.error(error); card.style.opacity = '1'; }
    }
    
    // --- ESTADO DE FLOTA ---
    function loadTechnicianStatus() {
        const listContainer = document.getElementById('col-tecnicos');
        const badge = document.getElementById('badge-tecnicos');
        if (!listContainer || !badge) {
            console.warn("Elementos de flota no encontrados");
            return;
        }

        fetch('/api/v1/tecnicos/?ordering=nombre') 
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.json();
            })
            .then(tecnicos => {
                listContainer.innerHTML = ''; 
                badge.innerText = tecnicos.length; 

                if (tecnicos.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-xs text-gray-400 mt-2">No hay t√©cnicos registrados</p>';
                    return;
                }
                tecnicos.forEach(tec => {
                    const isDisponible = tec.disponible;
                    const statusColorClass = isDisponible 
                        ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' 
                        : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                    const statusText = isDisponible ? 'Disponible' : 'Ocupado';
                    const tecDiv = document.createElement('div');
                    tecDiv.className = 'flex items-center justify-between p-3';
                    tecDiv.innerHTML = `
                        <div>
                            <p class="font-medium text-sm text-gray-900 dark:text-gray-100">${tec.nombre}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${tec.especialidad}</p>
                        </div>
                        <span class="text-xs font-bold px-2 py-0.5 rounded-full ${statusColorClass}">
                            ${statusText}
                        </span>
                    `;
                    listContainer.appendChild(tecDiv);
                });
            })
            .catch(error => {
                console.error("Error cargando lista de t√©cnicos:", error);
                listContainer.innerHTML = '<p class="text-red-500 p-3">Error al cargar flota.</p>';
            });
    }

    // --- CARGA PRINCIPAL DEL TABLERO ---
    function loadKanbanBoard() {
        console.log(`Actualizando tablero... ${new Date().toLocaleTimeString()}`);
        
        // Cargar t√©cnicos disponibles (para mapa y dropdowns)
        fetch('/api/v1/tecnicos/?disponible=true')
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.json();
            })
            .then(technicians => {
                allTechnicians = technicians;
                if(window.google && map) {
                    updateMapMarkers(technicians); 
                }
                // Traer √ìrdenes (solo despu√©s de tener los t√©cnicos)
                return Promise.all([
                    fetch('/api/v1/ordenes/?estado=PENDIENTE').then(r => r.json()),
                    fetch('/api/v1/ordenes/?estado=ASIGNADA').then(r => r.json()),
                    fetch('/api/v1/ordenes/?estado=EN_CAMINO').then(r => r.json()),
                    fetch('/api/v1/ordenes/?estado=EN_PROCESO').then(r => r.json())
                ]);
            })
            .then(([pendientes, asignadas, enCamino, enProceso]) => {
                const colPendientes = document.getElementById('col-pendientes');
                const colAsignadas = document.getElementById('col-asignadas');
                const colEjecucion = document.getElementById('col-ejecucion');

                colPendientes.innerHTML = '';
                document.getElementById('badge-pendientes').innerText = pendientes.length;
                if(pendientes.length === 0) colPendientes.innerHTML = '<p class="text-center text-xs text-gray-400 mt-2">Sin √≥rdenes</p>';
                pendientes.forEach(o => colPendientes.appendChild(createOrderCard(o, 'PENDIENTE')));

                colAsignadas.innerHTML = '';
                document.getElementById('badge-asignadas').innerText = asignadas.length;
                if(asignadas.length === 0) colAsignadas.innerHTML = '<p class="text-center text-xs text-gray-400 mt-2">Sin √≥rdenes</p>';
                asignadas.forEach(o => colAsignadas.appendChild(createOrderCard(o, 'ASIGNADA')));

                const ejecucion = [...enCamino, ...enProceso];
                colEjecucion.innerHTML = '';
                document.getElementById('badge-ejecucion').innerText = ejecucion.length;
                if(ejecucion.length === 0) colEjecucion.innerHTML = '<p class="text-center text-xs text-gray-400 mt-2">Sin √≥rdenes</p>';
                ejecucion.forEach(o => colEjecucion.appendChild(createOrderCard(o, 'EJECUCION')));
            })
            .catch(error => {
                console.error("Error cargando el tablero:", error);
                document.getElementById('col-pendientes').innerHTML = '<p class="text-red-500 p-3">Error al cargar √≥rdenes.</p>';
                document.getElementById('col-asignadas').innerHTML = '<p class="text-red-500 p-3">Error al cargar √≥rdenes.</p>';
                document.getElementById('col-ejecucion').innerHTML = '<p class="text-red-500 p-3">Error al cargar √≥rdenes.</p>';
            });

        // Cargar la lista de TODA la flota (en paralelo)
        loadTechnicianStatus();
    }
    
    // --- L√ìGICA DE EMERGENCIA ---
    function setEmergencyUI(isEmergency, message) {
        SystemState.is_emergency = isEmergency; 
        emergencyButton.innerText = "Modo Emergencia"; 

        if (isEmergency) {
            emergencyBanner.classList.remove('hidden');
            emergencyBannerMessage.innerText = message;
            emergencyButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            emergencyButton.classList.add('bg-red-600', 'hover:bg-red-700', 'animate-pulse');
        } else {
            emergencyBanner.classList.add('hidden');
            emergencyButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'animate-pulse');
            emergencyButton.classList.add('bg-green-500', 'hover:bg-green-600');
        }
    }

    function closeProtocolModal() {
        protocolModal.classList.add('hidden');
    }

    async function checkSystemState() {
        if (!emergencyButton || !emergencyBanner || !emergencyBannerMessage) {
            console.error("Elementos de UI de emergencia no encontrados.");
            return;
        }
        try {
            const response = await fetch('/api/v1/system-state/');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            setEmergencyUI(data.is_emergency, data.message);
        } catch (error) {
            console.error("Error chequeando estado:", error);
            emergencyButton.innerText = "Error Estado";
            emergencyButton.classList.add('bg-gray-500');
        }
    }

    async function toggleEmergencyMode() {
        let customMessage = null;
        if (!SystemState.is_emergency) {
             customMessage = prompt(
                "Va a activar el Modo Emergencia. El bot dejar√° de tomar √≥rdenes.\n\n(Opcional) Escriba un mensaje para los clientes:",
                "Estamos experimentando una falla masiva en el sector. Nuestros t√©cnicos ya est√°n informados."
            );
            if (customMessage === null) return;
        }

        emergencyButton.disabled = true;
        emergencyButton.innerText = "Actualizando...";
        
        try {
            const response = await fetch('/api/v1/system-state/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ message: customMessage })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            setEmergencyUI(data.is_emergency, data.message);
            if (data.is_emergency) {
                protocolModal.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error activando emergencia:", error);
        } finally {
            emergencyButton.disabled = false;
        }
    }
    
    // ======================================================
    //     ¬°AQU√ç EST√Å LA MAGIA! (EL C√ìDIGO DE INICIO)
    // =G====================================================
    document.addEventListener("DOMContentLoaded", function() {
        
        // 1. Asignamos las variables del DOM aqu√≠
        emergencyButton = document.getElementById('emergency-button');
        emergencyBanner = document.getElementById('emergency-banner');
        emergencyBannerMessage = document.getElementById('emergency-banner-message');
        protocolModal = document.getElementById('protocol-modal');

        // 2. Cargamos el estado de emergencia
        checkSystemState(); 
        
        // 3. Revisamos si Google Maps carg√≥ (initMap() es llamado por el <script> de abajo)
        if (!window.google) {
             console.error("Google Maps no carg√≥. Revisa la API Key.");
        }
        // initMap() se llamar√° autom√°ticamente por el 'callback=initMap'

        // 4. Iniciamos el auto-refresh
        setInterval(loadKanbanBoard, 60000); // 60000 ms = 1 minuto
    });

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADyfobEJl8oIqIVXDfWGNfzLx7aJZLj2A&callback=initMap" 
    async defer></script>

{% endblock javascript %}